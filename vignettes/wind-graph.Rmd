---
title: "Improving the graph with wind"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Improving the graph with wind}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(GeoPressureR)
library(ecmwfr)
library(raster)
library(ncdf4)
library(leaflet)
```

In this vignette, we will enhance the [basic graph](./articles/basic-graph) by adding the wind speed. This allows to defines the movement model on the airspeed (instead of groundspeed). In addition, we can extract windsupport information on the journey of the bird. 

```{r}
pam_data <- pam_read(
  pathname = system.file("extdata", package = "GeoPressureR"),
  crop_start = "2017-06-20", crop_end = "2018-05-02"
)
pam_data <- trainset_read(pam_data, pathname = system.file("extdata", package = "GeoPressureR"))
pam_data <- pam_sta(pam_data)
data("static_prob", package = "GeoPressureR")
```

## Download wind data

Wind data is available at high resolution (1hr, 0.25Â°, 37 pressure level) on [ERA5 hourly data on pressure levels](https://doi.org/10.24381/cds.bd0915c6). And this data is easily accessible through the [`ecmfr`](https://bluegreen-labs.github.io/ecmwfr) package. 
As the flight are of short duration, we suggest to download a file for each flight.

The first step is to setup-up your CDS access. You will need to create an account on [https://cds.climate.copernicus.eu/](https://cds.climate.copernicus.eu/user/register) to generate your API key and uid number. You can stored them in your `.Rprofile` with the commented code.
 
```{r, eval=F}
#Sys.setenv( cds.key="Insert_your_CDS_API_KEY_here")
#Sys.setenv( cds.user="Insert_your_CDS_UID_here")
# usethis::edit_r_environ()
cds.key <- Sys.getenv('cds.key')
cds.user <- Sys.getenv('cds.user')
wf_set_key(user = cds.user, key = cds.key, service = "cds")
```

To efficiently query only the data needed, we will sub-select the pressure level needed for each flight. We enter the [37 pressure level of ERA-5](https://confluence.ecmwf.int/display/CKB/ERA5%3A+data+documentation#ERA5:datadocumentation-Levellistings) and define the geographical area.

```{r, eval=F}
possible_pressure = c(1, 2, 3, 5, 7, 10, 20, 30, 50, 70, seq(100,250,25), seq(300,750,50), seq(775,1000,25))

area = extent(static_prob[[1]])
area = c(area@ymax, area@xmin, area@ymin, area@xmax)
```

It will be faster to send all the requests (one per flight) with `wf_request()` using `transfer = F` without waiting to get the data from one before requesting the next. These query can be very quick or sometime take a couple of hours, usually not more. You can monitor easily at [https://cds.climate.copernicus.eu/cdsapp#!/yourrequests](https://cds.climate.copernicus.eu/cdsapp#!/yourrequests) the status of your requests, delete them or download them manually if needed. 

```{r, eval=F}
req <- list()
for (i_s in seq_len(nrow(pam_data$sta)-1)){
  # Get the timeserie of the flight on a 1 hour resolution
  flight_time = seq(round(pam_data$sta$end[i_s]-30*60, units = "hours"), round(pam_data$sta$start[i_s+1]+30*60, units = "hours"), by=60*60)
  
  # Find the pressure level needed during this flight
  flight_id =  flight_time[1] <= pam_data$pressure$date & pam_data$pressure$date <=  tail(flight_time,1)
  pres_id_min = sum(!(min(pam_data$pressure$obs[flight_id]) < possible_pressure))
  pres_id_max = sum(max(pam_data$pressure$obs[flight_id]) > possible_pressure)+1
  flight_pres_id = seq(pres_id_min, min(pres_id_max,length(possible_pressure)))
  
  # Prepare the query
  request <- list(
    dataset_short_name = "reanalysis-era5-pressure-levels",
    product_type   = "reanalysis",
    format = "netcdf",
    variable = c('u_component_of_wind', 'v_component_of_wind'),
    pressure_level = possible_pressure[flight_pres_id],
    year = sort(unique(format(flight_time,'%Y'))),
    month = sort(unique(format(flight_time,'%m'))),
    day = sort(unique(format(flight_time,'%d'))),
    time = sort(unique(format(flight_time,'%H:%M'))),
    # area is specified as N, W, S, E
    area = area
  )
  # We can send the query without downloading the data. This allows to send all of them and then wait to get them back later.  
  req[[i_s]] <- wf_request(user = cds.user, request = request, transfer = F)
}
```

Define the folder where to download the data. `wf_transfer()` will download the file in the temporary folder by default.

```{r, eval=F}
dir.save <- '~'
```

The following code will return the status of the request if then have not yet been processed, or return the data otherwise. I suggest to check on [https://cds.climate.copernicus.eu/cdsapp#!/yourrequests] if the request have been completed before running this code. It can take a couple of minutes to a few hours.    

```{r, eval=F}
for (i_s in seq_len(nrow(pam_data$sta)-1)){
  filename = paste0("18IC_",i_s,".nc")
  wf_transfer(url = req[[i_s]]$request_id, service = "cds", user = cds.user, path = dir.save, filename=filename)
}
```

## Create graph

We first create the graph identically to in [basic graph](./articles/basic-graph)

```{r, eval=F}
grl <- graph_create(static_prob, thr_prob_percentile = .99, thr_gs = 150)  
```


## Add wind to graph

```{r, eval=F}
filename = paste0(dir.save,"/","18IC_")
grl$ws <- graph_add_wind(grl, pam_data$pressure, filename, thr_as = 100)
```
