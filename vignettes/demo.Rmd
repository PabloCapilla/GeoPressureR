---
title: "Demo"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{demo}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Demo

## Setup

For this demo, we will use the standard packages for processing the raw geolocator data. If you haven't installed them, use the following lines:
```{r, eval = FALSE}
devtools::install_github("GeoPressureR")
```

```{r setup}
library(GeoPressureR)
library(GeoLight)
library(pamlr)
library(raster)
library(leaflet)
library(ggplot2)
```

## Load data
Load the hoopoe data and set the basic information for this track
```{r}
data("hoopoe")
lon.calib = 7.103	
lat.calib = 46.125
crop.start = as.POSIXct("2016-07-01","%Y-%m-%d", tz="UTC")
crop.end = as.POSIXct("2017-06-01","%Y-%m-%d", tz="UTC")
```

## Activity Processing
Using PalmR package, we crop the data  and classify the activity. See more possible classification on https://kiranlda.github.io/PAMLrManual/index.html
```{r}
PAM_data = create_crop(hoopoe,crop.start,crop.end)
behaviour = classify_flap(dta = PAM_data$acceleration, period = 12, to_plot=F)
PAM_data$acceleration$class = behaviour$classification==3
```

## Editing of Pressure and Activity on Trainset
For the matching of pressure to work correctly, we need that the bird was exactly at the same location during the stationary period. It is very likely that a manual editing of the activity classification is required.

We suggest using TRAINNSET to edit your classification. The following code will export the automatically generated classification. It can be editted on TRAINSET, then export it back into.

Make sure to keep these classified file on your project folder (e.g. under `/data/`)
```{r eval=F}
PAM_data = trainset.edit(PAM_data, file.location="../data/")
```

To re-edit an existing labeled file you can simply re-open the file on [trainset.geocene.com](https://trainset.geocene.com/) and read this file with `trainset.read`.
```{r}
# browseURL("https://trainset.geocene.com/")
PAM_data = trainset.read(PAM_data, file.location="../data/")
```

I will write another vignette on the best practice to label activity and pressure data. 

## Activity to stationary period
Build a data.frame of the stationary period.
```{r}
sta = data.frame(
  start = c(crop.start,behaviour$timetable$end),
  end = c(behaviour$timetable$start,crop.end),
  nextFlightDuration = c(behaviour$timetable$`Duration (h)`,0)
)
sta$staID = 1:nrow(sta)
```

Assign to each pressure measure the stationary period to which it belong to.
```{r}
staID = sapply(PAM_data$pressure$date, function(x) which(sta$start<=x & x<=sta$end))
staID[sapply(staID, function(x) length(x)==0)] = 0
PAM_data$pressure$staID = unlist(staID)
```

Initially, it might be easier to only query stationary period of a certain duration.
```{r}
min_duration = 60*24*2 # in minutes
staID_keep = sta$staID[(sta$end-sta$start)>min_duration]
PAM_data$pressure$staID[!(PAM_data$pressure$staID %in% staID_keep)] = NA
```

## Request map of pressure
In this part, we query the maps of pressure from the GeoPressure API ([see more information on github.com/Rafnuss/GeoPressureServer/](https://github.com/Rafnuss/GeoPressureServer/)). See details explanation of the parameter on https://github.com/Rafnuss/GeoPressureServer/#request
```{r}
extent = c(-6,43,0,47) # coordinates of the map to request (W,E,S,N) 
scale = 1 # request on a 1Â° grid to make the code faster
maxSample = 100
margin = 30 # roughly equivalent to 3hPa
rasterList = geopressure.map(PAM_data$pressure, extent=c(-16,20,0,50), scale=scale, maxSample=maxSample, margin=margin)
```

Compute probability map
```{r}
s = 1 # standard deviation of pressure
thr = 0.9 # threashold of value acceptable 
rasterProbList = geopressure.Probmap(rasterList, s=s, thr=thr)
```

## Display
```{r}
i_r = 3;

leaflet() %>% addTiles() %>%
  addRasterImage(rasterProbList[[i_r]], opacity = 0.8, group="Probability") %>%
  addRasterImage(rasterList[[i_r]][[1]], opacity = 0.8, group="Mismatch") %>%
  addRasterImage(rasterList[[i_r]][[2]], opacity = 0.8, group="Threashold") %>%
  # addLegend(pal = pal, values = values(v[[i_s]][[3]]), title = "Probability") %>% 
  addLayersControl(
    overlayGroups = c("Probability","Mismatch","Threashold"),
    options = layersControlOptions(collapsed = FALSE)
  ) %>% hideGroup(c("Mismatch","Threashold"))
```


## Check pressure match
```{r}
i_r=1

i_s = metadata(rasterProbList[[i_r]])$staID

# find the max value of probability
tmp = as.data.frame(rasterProbList[[i_r]],xy=T)
lon = tmp$x[which.max(tmp[,3])]
lat = tmp$y[which.max(tmp[,3])]

# filter pressure for the stationary period
# include flight period before and after
pres = PAM_data$pressure
id = pres$staID==i_s & !is.na(pres$staID)
pressure = list(
  obs = pres$obs[id],
  date = pres$date[id]
)

# query the pressure at this location
ptsr  = geopressure.timeseries(lon, lat, pressure = pressure)
```
```{r}
ggplot() +
  geom_line(data=as.data.frame(pressure), aes(x=date,y=obs)) +
  geom_point(data=as.data.frame(ptsr), aes(x=date,y=pressure))
```







# Combine with Light
Standard processure following https://geolocationmanual.vogelwarte.ch/twilight.html
Get the twilight
```{r}
#twl = twilightCalc(PAM_data$light$date, PAM_data$light$obs, LightThreshold = 2, ask = F)
```

Calibraiton
```{r}
# d.calib = subset(twl, (tSecond<=head(behaviour$timetable$start,1)) | 
#                        (tFirst>=tail(behaviour$timetable$end,1)))
# 
# gE = getElevation(twl = d.calib, known.coord = c(lon.calib, lat.calib),method = "gamma", plot = F)
# 
# crds = coord(twl, degElevation = 90-gE[1], note = FALSE)
# tripMap(crds)
# points(lon.calib, lat.calib, pch = 21, cex = 1.5, bg = "white") # adding the release location
```
