---
title: "Combine with Geolight"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Combine with Geolight}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

In this vignette, we will combine the probability map of pressure computed in the vignette [How to use GeoPressureR](using-geopressurer.html) with probability map of light data using the package [`GeoLocTools`](https://github.com/slisovski/GeoLocTools).

## Setup

```{r setup}
library(GeoPressureR)
library(leaflet)
library(GeoLocTools)
setupGeolocation()
```

Read pam data and define basic information about calibration. The second calibration is so short (1 day), that we don not consider it here
```{r}
lon.calib <- 17.05	
lat.calib <- 48.9
tm.calib.1 <- c(as.POSIXct("2017-06-20"), as.POSIXct("2017-07-20"))
# tm.calib.2 <- c(as.POSIXct("2018-04-29"), as.POSIXct("2018-05-1"))
lon.lim <- c(-18, 23)
lat.lim <- c(4, 53)
tm.lim <- c("2017-06-20", "2018-05-02")
```


```{r}
pam_data = pam_read(pathname = system.file("extdata", package = "GeoPressureR"),
                    crop_start = tm.lim[1], crop_end = tm.lim[2])
```

and convert to the format required in the `GeoLocTools` functions.

```{r}
raw = data.frame(
  Date = pam_data$light$date,
  Light = pam_data$light$obs
)
```

## Twilight Annotation

The twilight annotation follow closely the [chapter 4 of the geolocation manual](https://geolocationmanual.vogelwarte.ch/twilight.html) adding a manual editing through trainset.

Find the time of twilight
```{r}
twl <- findTwilights(raw, 
                     threshold = min(raw$Light[raw$Light>0]), # first light of the day
                     include = "2017-09-23 00:00:00 UTC" # Not sure why
                     )
attr(twl$Twilight, "tzone") <- "UTC" 
```

You can perform the automatic editing

```{r, eval=F}
twl <- twilightEdit(twl, plot=F)
```

But I would advice to do it manually with trainset. After running the rest of the analysis, you can come back to this step to improve the light derived map.

Read more about trainset in the vignette [How to label tracks](labeling_tracks.html#introduction-to-trainset). In this case, use any label name you wish to delete a datapoint and leave it empty (black dot) to keep the datapoint.

```{r, eval=F}
utils::write.csv(
  data.frame(
    series = ifelse(twl$Rise,"Rise","Set"),
    timestamp = strftime(twl$Twilight, "%Y-%m-%dT00:00:00Z", tz = "UTC"),
    value = as.numeric(format(twl$Twilight, "%H")) * 60 + as.numeric(format(twl$Twilight, "%M")),
    label = ifelse(is.null(twl$Delete), "", ifelse(twl$Delete,'Delete',''))
  ),
  paste0(system.file("extdata", package = "GeoPressureR"), "/18LX_light.csv"),
  row.names = FALSE
)
browseURL("https://trainset.geocene.com/")
```

```{r}
csv <- utils::read.csv( paste0(system.file("extdata", package = "GeoPressureR"), "/18LX_light-labeled.csv"))
twl$Deleted = !csv$label==""
```

Visualize

```{r}
offset <- 12
lightImage( tagdata = raw,
            offset = offset,     
            zlim = c(0, 4))

tsimagePoints(twl$Twilight, offset = offset, pch = 16, cex = 1.2,
              col = ifelse(twl$Deleted, "grey20", ifelse(twl$Rise, "firebrick", "cornflowerblue")))

tsimageDeploymentLines(twl$Twilight, lon.calib, lat.calib, offset = offset,
                       lwd = 2, col = adjustcolor("orange", alpha.f = 0.8))

abline(v = tm.calib.1, lty = c(1,2), col = "firebrick", lwd = 1.5)
#abline(v = tm.calib.2, lty = c(1,2), col = "firebrick", lwd = 1.5)
```

## Calibration

Instead of calibrating the twilights in term of duration, we model the zenith angle error

```{r}
twl.calib <- subset(twl, !Deleted & Twilight>=tm.calib.1[1] & Twilight<=tm.calib.1[2])
```

```{r}
sun <- solar(twl.calib$Twilight)
z = refracted(zenith(sun, lon.calib, lat.calib)) 
fitE = MASS::fitdistr(z,"gamma")
hist(z,freq=F)
z.axes = seq(90,100,0.1)
lines(z.axes, dgamma(z.axes, fitE$estimate["shape"], fitE$estimate["rate"]), col="red")
```

## Stationary period

```{r}
# pam_data = pam_classify(pam_data, min_duration = 30)
pam_data = trainset_read(pam_data, pathname=system.file("extdata", package = "GeoPressureR"))
pam_data = pam_sta(pam_data)

twilight_sta_id <- sapply(twl$Twilight, function(x) which(pam_data$sta$start < x & x < pam_data$sta$end))
twilight_sta_id[sapply(twilight_sta_id, function(x) length(x) == 0)] <- 0
twl$sta_id <- unlist(twilight_sta_id)
```

## Proability map

```{r}
lon = seq(lon.lim[1], lon.lim[2], by=.25)
lat = seq(lat.lim[1], lat.lim[2], by=.25)
g = data.frame(
  lon = rep(lon,length(lat)),
  lat = rep(lat,each=length(lon))
)
```

```{r}
twl.clean <- subset(twl, !Deleted)
sun <- solar(twl.clean$Twilight)
t = apply(g,1, function(x) {
    z = refracted(zenith(s, x[1], x[2])) 
    dgamma(z, fitE$estimate["shape"], fitE$estimate["rate"])
  })
```

```{r}
w=0.1
```

```{r}
raster_prob_list <- c()
for (i_s in seq_len(nrow(pam_data$sta))){
  id = twl.clean$sta_id==pam_data$sta$sta_id[i_s]
  if (sum(id)>1){
    g$p = exp(colSums(w*log(t[id,])))
  } else if(sum(id)==1) {
    g$p = t[id,]
  } else {
    g$p = 1
  }
  gr <- rasterFromXYZ(g)
  crs(gr) <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"
  metadata(gr) <- list(
        sta_id = pam_data$sta$sta_id[i_s],
        nb_sample = sum(id)
      )
  raster_prob_list[[i_s]] <- gr
}
```

```{r}
li_s=list()
l = leaflet() %>% addTiles() 
for (i_r in 1:length(raster_prob_list)){
  i_s = metadata(raster_prob_list[[i_r]])$sta_id
  info = pam_data$sta[pam_data$sta$sta_id==i_s,]
  info_str = paste0(i_s," | ",info$start,"->",info$end)
  li_s <- append(li_s, info_str)
  l = l %>% addRasterImage(raster_prob_list[[i_r]], opacity = 0.8, group=info_str) 
}
l %>% 
  addLayersControl(
    overlayGroups = li_s,
    options = layersControlOptions(collapsed = FALSE)
  ) %>% hideGroup(tail(li_s,length(li_s)-1))
```



